volumes:
    prom_data:
    grafana_data:

services:
    init:
        build:
            context: ./config-init
        container_name: init
        volumes:
            - ./config:/host-config
            - ./prometheus/prometheus.yml:/defaults/prometheus.yml:ro
            - ./grafana/provisioning:/defaults/grafana/provisioning:ro
        networks:
            - monitoring
        restart: "no"
        profiles: ["init"]

    fritz:
        build:
            context: ./fritz
        image: local/fritz-exporter:latest
        container_name: fritz
        command: ["--config=/etc/fritz/fritz.yml"]
        volumes:
            - ./fritz/fritz.yml:/etc/fritz/fritz.yml:ro       
        ports:
            - "18000:18000"
        networks:
            - monitoring
        restart: unless-stopped

    blackbox:
        image: prom/blackbox-exporter:latest
        container_name: blackbox
        command:
            - --config.file=/etc/blackbox/blackbox.yml
            - --web.listen-address=:18001
        ports:
            - "18001:18001"
        volumes:
            - ./blackbox/blackbox.yml:/etc/blackbox/blackbox.yml:ro
        cap_add:
            - NET_RAW
        networks:
            - monitoring
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "wget", "-qO-", "http://localhost:18001/metrics"]
            interval: 60s
            timeout: 10s
            retries: 5
            start_period: 60s

    ip:
        build:
            context: ./ip
        image: local/ip-exporter:latest
        container_name: ip
        cap_add:
            - NET_RAW
        ports:
            - "18002:18002"
        networks:
            - monitoring
        restart: unless-stopped

    prometheus:
        image: prom/prometheus:latest
        container_name: prometheus
        command:
            - --config.file=/etc/prometheus/prometheus.yml
            - --storage.tsdb.path=/prometheus
            - --storage.tsdb.retention.time=24h
            - --web.enable-lifecycle
            - --web.listen-address=:18003
        ports:
            - "18003:18003"
        volumes:
            - ./config/prometheus:/etc/prometheus:ro
            - prom_data:/prometheus
        depends_on:
            fritz:
                condition: service_started
            blackbox:
                condition: service_healthy
        networks:
            - monitoring
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "wget", "-qO-", "http://localhost:18003/-/ready"]
            interval: 60s
            timeout: 10s
            retries: 6
            start_period: 120s

    grafana:
        image: grafana/grafana:latest
        container_name: grafana
        environment:
            GF_SECURITY_ADMIN_USER: admin
            GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
            GF_PATHS_PROVISIONING: /etc/grafana/provisioning
            GF_AUTH_ANONYMOUS_ENABLED: "true"
            GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer
            GF_AUTH_ANONYMOUS_ORG_NAME: Main Org.
            GF_USERS_ALLOW_SIGN_UP: "false"
            GF_AUTH_ANONYMOUS_HIDE_VERSION: "true"
            GF_SERVER_HTTP_PORT: "18004"
        ports:
            - "18004:18004"
        volumes:
            - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
            - grafana_data:/var/lib/grafana
        depends_on:
            prometheus:
                condition: service_healthy
        networks:
            - monitoring
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "wget", "-qO-", "http://localhost:18004/api/health"]
            interval: 60s
            timeout: 10s
            retries: 6
            start_period: 120s

networks:
    monitoring: {}
